<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArtiCentro Designs - Smart BOQ System</title>
    
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f1f3f4 0%, #e0f2e0 25%, #e8f5e8 50%, #e0f2e0 75%, #f1f3f4 100%);
            color: #1a1a1a;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(34, 197, 94, 0.12) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(154, 205, 50, 0.10) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(107, 142, 35, 0.08) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
            animation: backgroundFloat 20s ease-in-out infinite;
        }

        @keyframes backgroundFloat {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(1deg); }
        }

        .header {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(154, 205, 50, 0.3);
            padding: 20px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.5);
            position: relative;
            animation: slideInDown 0.8s ease-out;
        }

        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .logo {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 24px;
            color: #000;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .logo:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }

        .logo input[type="file"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.9);
        }

        .company-info h1 {
            font-size: 28px;
            font-weight: 700;
            color: #22c55e;
        }

        .company-info p {
            color: #d1d5db;
            font-size: 14px;
        }

        .project-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .input-group label {
            font-size: 14px;
            color: #9ca3af;
            font-weight: 600;
        }

        .input-group input, .input-group select {
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.9);
            color: #1f2937;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #22c55e;
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1);
        }

        .main-content {
            padding: 20px;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: #000;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }

        .btn-secondary {
            background: #374151;
            color: #ffffff;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-danger {
            background: #dc2626;
            color: #ffffff;
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        .table-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(154, 205, 50, 0.5);
            animation: fadeInUp 0.8s ease-out 0.2s both;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .table-wrapper {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 2000px;
        }

        th {
            background: linear-gradient(135deg, #9ACD32, #6B8E23);
            color: #2F4F2F;
            padding: 12px 8px;
            text-align: left;
            font-size: 12px;
            font-weight: 700;
            position: sticky;
            top: 0;
            z-index: 10;
            border-right: 1px solid #6B8E23;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
        }

        th:hover {
            background: linear-gradient(135deg, #B8E356, #7BA428);
            transform: translateY(-1px);
        }

        .sort-icon {
            font-size: 10px;
            opacity: 0.7;
            margin-left: 4px;
        }

        th.sorted-asc .sort-icon::after {
            content: ' ‚Üë';
            color: #2F4F2F;
            font-weight: bold;
        }

        th.sorted-desc .sort-icon::after {
            content: ' ‚Üì';
            color: #2F4F2F;
            font-weight: bold;
        }

        td {
            padding: 8px;
            border-bottom: 1px solid #8FBC8F;
            border-right: 1px solid #8FBC8F;
            font-size: 12px;
            color: #2F4F2F;
        }

        tr:hover {
            background: rgba(154, 205, 50, 0.1);
        }

        .editable {
            background: transparent;
            border: 1px solid transparent;
            color: #2F4F2F;
            padding: 4px 6px;
            border-radius: 4px;
            width: 100%;
            font-size: 12px;
        }

        .editable:focus {
            outline: none;
            border-color: #9ACD32;
            background: rgba(255, 255, 255, 0.9);
        }

        select.editable {
            background: rgba(255, 255, 255, 0.8);
            cursor: pointer;
        }

        .calculated {
            background: rgba(154, 205, 50, 0.2);
            color: #2F4F2F;
            font-weight: 700;
            border: 1px solid #9ACD32;
        }

        .summary {
            margin-top: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .summary-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #9ACD32;
            border: 1px solid #8FBC8F;
        }

        .summary-card h3 {
            font-size: 14px;
            color: #2F4F2F;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .summary-card .value {
            font-size: 24px;
            font-weight: 700;
            color: #6B8E23;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            border: 2px solid #9ACD32;
            color: #2F4F2F;
        }

        .close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 24px;
            cursor: pointer;
            color: #9ca3af;
        }

        .close:hover {
            color: #ffffff;
        }

        .row-actions {
            display: flex;
            gap: 5px;
        }

        .row-actions button {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }

        .delete-btn {
            background: #dc2626;
            color: white;
        }

        .duplicate-btn {
            background: #2563eb;
            color: white;
        }

        .tab-navigation {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #8FBC8F;
            padding-bottom: 10px;
        }

        .tab-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px 8px 0 0;
            background: rgba(255, 255, 255, 0.7);
            color: #2F4F2F;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #9ACD32, #6B8E23);
            color: #2F4F2F;
            border-bottom-color: #9ACD32;
        }

        .tab-btn:hover:not(.active) {
            background: rgba(154, 205, 50, 0.3);
        }

        .tab-content {
            display: none !important;
        }

        .tab-content.active {
            display: block !important;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .dashboard-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(154, 205, 50, 0.5);
            box-shadow: 
                0 15px 35px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            animation: fadeInUp 0.8s ease-out 0.4s both;
        }

        .dashboard-section:hover {
            transform: translateY(-5px);
            box-shadow: 
                0 25px 50px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.15);
        }

        .dashboard-section h3 {
            color: #1a1a1a;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: 700;
            border-bottom: 2px solid #9ACD32;
            padding-bottom: 8px;
        }

        .financial-summary {
            grid-column: 1 / -1;
        }

        .category-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .category-item {
            background: rgba(154, 205, 50, 0.1);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #9ACD32;
        }

        .category-item h4 {
            color: #2F4F2F;
            font-size: 14px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .category-item .amount {
            font-size: 18px;
            font-weight: 700;
            color: #6B8E23;
        }

        .category-item .percentage {
            font-size: 12px;
            color: #556B2F;
            margin-top: 4px;
        }

        .additional-charges {
            margin-top: 20px;
        }

        .charge-input {
            display: grid;
            grid-template-columns: 2fr 1fr 80px;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .charge-input input {
            padding: 8px 12px;
            border: 1px solid #8FBC8F;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.9);
            color: #2F4F2F;
        }

        .charge-input button {
            padding: 8px;
            border: none;
            border-radius: 6px;
            background: #dc2626;
            color: white;
            cursor: pointer;
        }

        .btn-add-material {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: #000;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .btn-add-material:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(34, 197, 94, 0.3);
        }

        .chart-container {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(154, 205, 50, 0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 300px;
        }

        .chart-container canvas {
            max-width: 100%;
            height: auto;
        }

        @media (max-width: 768px) {
            .project-info {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .btn {
                justify-content: center;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .tab-navigation {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo-section">
            <div class="logo" onclick="document.getElementById('logoUpload').click()" title="Click to upload logo">
                <span id="logoText">AC</span>
                <input type="file" id="logoUpload" accept="image/*" onchange="uploadLogo(event)">
            </div>
            <div class="company-info">
                <h1><span style="color: #c0c0c0;">Arti</span><span style="color: #808080;">Centro</span> <span style="color: #9ACD32;">Designs</span></h1>
                <p>Interior Design and Build ‚Ä¢ Renovation Specialists</p>
            </div>
        </div>
        
        <div class="project-info">
            <div class="input-group">
                <label>Project ID</label>
                <input type="text" id="projectId" placeholder="AC-2024-001">
            </div>
            <div class="input-group">
                <label>Project Name</label>
                <input type="text" id="projectName" placeholder="Modern Condo Renovation">
            </div>
            <div class="input-group">
                <label>Client Name</label>
                <input type="text" id="clientName" placeholder="Client Name">
            </div>
            <div class="input-group">
                <label>Project Budget (‚Ç±)</label>
                <input type="number" id="projectBudget" placeholder="500000">
            </div>
            <div class="input-group">
                <label>Project Type</label>
                <select id="projectType">
                    <option value="">Select Type</option>
                    <option value="Interior Design">Interior Design</option>
                    <option value="Fit Out">Fit Out</option>
                    <option value="Renovation">Renovation</option>
                    <option value="Construction">Construction</option>
                    <option value="Others">Others</option>
                </select>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="tab-navigation">
            <button class="tab-btn active" onclick="showTab('boq')">üìã BOQ Table</button>
            <button class="tab-btn" onclick="showTab('summary')">üìÑ Summary Table</button>
            <button class="tab-btn" onclick="showTab('dashboard')">üìä Dashboard</button>
        </div>

        <div class="project-selector" style="margin-bottom: 20px; padding: 15px; background: rgba(255, 255, 255, 0.7); border-radius: 12px; border: 1px solid rgba(154, 205, 50, 0.3);">
            <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                <div style="display: flex; flex-direction: column; gap: 5px;">
                    <label style="font-size: 12px; color: #6b7280; font-weight: 500;">Current Project</label>
                    <select id="projectSelector" onchange="switchProject()" style="padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; background: rgba(255, 255, 255, 0.9); color: #1f2937; min-width: 200px;">
                        <option value="">Select Project</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="createNewProject()">üìÅ New Project</button>
                <button class="btn btn-secondary" onclick="duplicateProject()">üìã Duplicate Project</button>
                <button class="btn btn-danger" onclick="deleteProject()">üóëÔ∏è Delete Project</button>
            </div>
        </div>

        <div class="controls">
            <button class="btn btn-primary" onclick="addRow()">‚ûï Add Item</button>
            <button class="btn btn-secondary" onclick="exportToExcel()">üìä Export Excel</button>
            <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">üìÅ Import Excel</button>
            <input type="file" id="importFile" accept=".xlsx,.xls" style="display: none;" onchange="importFromExcel(event)">
            <button class="btn btn-secondary" onclick="saveCurrentProject()">üíæ Save Project</button>
            <button class="btn btn-secondary" onclick="loadAllProjects()" title="Refresh project list">üîÑ Refresh Projects</button>
            
            <div style="display: flex; gap: 10px; align-items: center; margin-left: auto; background: rgba(255, 255, 255, 0.7); padding: 8px 12px; border-radius: 8px;">
                <label style="color: #1f2937; font-size: 14px; font-weight: 500;">Margin %:</label>
                <input type="number" id="marginInput" value="26" min="0" max="100" step="0.1" onchange="updateMargin()" style="width: 80px; padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 4px; background: rgba(255, 255, 255, 0.9); color: #1f2937; font-size: 14px;">
            </div>
        </div>

        <!-- BOQ Table Tab -->
        <div id="boq-tab" class="tab-content active">
            <div class="table-container">
                <div class="table-wrapper">
                    <table id="boqTable">
                        <thead>
                            <tr>
                                <th style="width: 70px; min-width: 70px;" onclick="sortTable('itemNo')">Item<br>No. <span class="sort-icon">‚ÜïÔ∏è</span></th>
                                <th style="width: 140px; min-width: 140px;" onclick="sortTable('phase')">Phase <span class="sort-icon">‚ÜïÔ∏è</span></th>
                                <th style="width: 130px; min-width: 130px;" onclick="sortTable('category')">Category <span class="sort-icon">‚ÜïÔ∏è</span></th>
                                <th style="width: 250px; min-width: 250px;" onclick="sortTable('description')">Description <span class="sort-icon">‚ÜïÔ∏è</span></th>
                                <th style="width: 90px; min-width: 90px;" onclick="sortTable('quantity')">Quantity <span class="sort-icon">‚ÜïÔ∏è</span></th>
                                <th style="width: 80px; min-width: 80px;" onclick="sortTable('unit')">Unit <span class="sort-icon">‚ÜïÔ∏è</span></th>
                                <th style="width: 110px; min-width: 110px;" onclick="sortTable('unitCost')">Unit Cost<br>(‚Ç±) <span class="sort-icon">‚ÜïÔ∏è</span></th>
                                <th style="width: 130px; min-width: 130px;" onclick="sortTable('totalItemCost')">Total Item<br>Cost (‚Ç±) <span class="sort-icon">‚ÜïÔ∏è</span></th>
                                <th style="width: 130px; min-width: 130px;">Discrepancy<br>(<span id="discrepancyPercentage">10</span>% <button onclick="editBufferPercentage('discrepancy')" style="background: none; border: none; color: #2F4F2F; cursor: pointer; font-size: 12px;" title="Edit percentage">‚úèÔ∏è</button>)</th>
                                <th style="width: 130px; min-width: 130px;">Operation<br>(<span id="operationPercentage">10</span>% <button onclick="editBufferPercentage('operation')" style="background: none; border: none; color: #2F4F2F; cursor: pointer; font-size: 12px;" title="Edit percentage">‚úèÔ∏è</button>)</th>
                                <th style="width: 110px; min-width: 110px;">Amount<br>(‚Ç±)</th>
                                <th style="width: 130px; min-width: 130px;">Contingency<br>(<span id="contingencyPercentage">10</span>% <button onclick="editBufferPercentage('contingency')" style="background: none; border: none; color: #2F4F2F; cursor: pointer; font-size: 12px;" title="Edit percentage">‚úèÔ∏è</button>)</th>
                                <th style="width: 130px; min-width: 130px;" onclick="sortTable('totalAmount')">Total Amount<br>(‚Ç±) <span class="sort-icon">‚ÜïÔ∏è</span></th>
                                <th style="width: 160px; min-width: 160px;" onclick="sortTable('supplier')">Supplier <span class="sort-icon">‚ÜïÔ∏è</span></th>
                                <th style="width: 160px; min-width: 160px;">Notes</th>
                                <th style="width: 90px; min-width: 90px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="boqTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Summary Table Tab -->
        <div id="summary-tab" class="tab-content">
            <div style="display: flex; gap: 10px; margin-bottom: 20px; align-items: center;">
                <button class="btn btn-primary" onclick="generateSummaryFromBOQ()">üîÑ Generate from BOQ</button>
                <button class="btn btn-primary" onclick="addSummaryRow()">‚ûï Add Summary Item</button>
                <button class="btn btn-secondary" onclick="exportSummaryToExcel()">üìä Export Summary</button>
                <div style="margin-left: auto; background: rgba(255, 255, 255, 0.7); padding: 8px 12px; border-radius: 8px;">
                    <span style="color: #1f2937; font-size: 14px; font-weight: 500;">Summary Total: </span>
                    <span id="summaryGrandTotal" style="color: #6B8E23; font-weight: 700; font-size: 16px;">‚Ç±0.00</span>
                </div>
            </div>
            
            <div class="table-container">
                <div class="table-wrapper">
                    <table id="summaryTable">
                        <thead>
                            <tr>
                                <th style="width: 80px; min-width: 80px;">Item</th>
                                <th style="width: 300px; min-width: 300px;">Description</th>
                                <th style="width: 120px; min-width: 120px;">Quantity</th>
                                <th style="width: 100px; min-width: 100px;">Unit</th>
                                <th style="width: 150px; min-width: 150px;">Total Cost (‚Ç±)</th>
                                <th style="width: 150px; min-width: 150px;">Margin (<span id="summaryMarginPercentage">26</span>%)</th>
                                <th style="width: 150px; min-width: 150px;">Total Amount (‚Ç±)</th>
                                <th style="width: 90px; min-width: 90px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="summaryTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard-tab" class="tab-content">
            <div class="dashboard-grid">
                <!-- Financial Summary -->
                <div class="dashboard-section financial-summary">
                    <h3>üí∞ Financial Summary</h3>
                    <div class="summary">
                        <div class="summary-card">
                            <h3>Total Cost (from BOQ)</h3>
                            <div class="value" id="dashBaseCost">‚Ç±0.00</div>
                        </div>
                        <div class="summary-card">
                            <h3>Margin (<span id="dashMarginPercentage">26</span>%)</h3>
                            <div class="value" id="dashMarginAmount">‚Ç±0.00</div>
                        </div>
                        <div class="summary-card">
                            <h3>Additional Charges</h3>
                            <div class="value" id="dashAdditionalCharges">‚Ç±0.00</div>
                        </div>
                        <div class="summary-card">
                            <h3>Discount</h3>
                            <div class="value" id="dashDiscount">‚Ç±0.00</div>
                        </div>
                        <div class="summary-card">
                            <h3>VAT (<span id="dashVatPercentage">1</span>% <button onclick="editVatPercentage()" style="background: none; border: none; color: #2F4F2F; cursor: pointer; font-size: 12px;" title="Edit VAT percentage">‚úèÔ∏è</button>)</h3>
                            <div class="value" id="dashVatAmount">‚Ç±0.00</div>
                        </div>
                        <div class="summary-card">
                            <h3>Grand Total</h3>
                            <div class="value" id="dashGrandTotal">‚Ç±0.00</div>
                        </div>
                        <div class="summary-card">
                            <h3>Remaining Budget</h3>
                            <div class="value" id="dashRemainingBudget">‚Ç±0.00</div>
                        </div>
                        <div class="summary-card">
                            <h3>Total Items</h3>
                            <div class="value" id="totalItems">0</div>
                        </div>
                        <div class="summary-card">
                            <h3>Budget Utilization</h3>
                            <div class="value" id="budgetUtil">0%</div>
                        </div>
                    </div>
                    
                    <div class="additional-charges">
                        <h4 style="color: #2F4F2F; margin-bottom: 15px;">Additional Charges</h4>
                        <div id="additionalChargesList"></div>
                        <div class="charge-input">
                            <input type="text" id="newChargeDescription" placeholder="Description (e.g., Permit Fees, Transportation)">
                            <input type="number" id="newChargeAmount" placeholder="Amount" step="0.01">
                            <button onclick="addAdditionalCharge()" class="btn btn-primary" style="padding: 8px 12px;">Add</button>
                        </div>
                    </div>
                    
                    <div class="additional-charges">
                        <h4 style="color: #2F4F2F; margin-bottom: 15px;">Discount</h4>
                        <div class="charge-input">
                            <input type="text" id="discountDescription" placeholder="Discount description (optional)" value="Project Discount">
                            <input type="number" id="discountAmount" placeholder="Discount amount" step="0.01" onchange="updateDiscount()">
                            <button onclick="clearDiscount()" class="btn btn-secondary" style="padding: 8px 12px;">Clear</button>
                        </div>
                    </div>
                </div>

                <!-- Category Breakdown -->
                <div class="dashboard-section">
                    <h3>üìä Cost Breakdown by Category</h3>
                    <div class="chart-container">
                        <canvas id="categoryChart" width="400" height="300"></canvas>
                    </div>
                    <div class="category-breakdown" id="categoryBreakdown">
                    </div>
                </div>

                <!-- Phase Breakdown -->
                <div class="dashboard-section">
                    <h3>üèóÔ∏è Cost Breakdown by Phase</h3>
                    <div class="chart-container">
                        <canvas id="phaseChart" width="400" height="300"></canvas>
                    </div>
                    <div class="category-breakdown" id="phaseBreakdown">
                    </div>
                </div>

                <!-- Labor Breakdown -->
                <div class="dashboard-section">
                    <h3>üë∑ Labor Cost Breakdown</h3>
                    <div class="chart-container">
                        <canvas id="laborChart" width="400" height="300"></canvas>
                    </div>
                    <div class="category-breakdown" id="laborBreakdown">
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary moved to Dashboard tab only -->
    </div>

    <!-- Material Management Modal -->
    <div id="materialModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeMaterialModal()">&times;</span>
            <h2 style="color: #2F4F2F; margin-bottom: 20px;">Add New Material</h2>
            <div class="input-group">
                <label>Material Name</label>
                <input type="text" id="newMaterialName" placeholder="e.g., Premium Ceramic Tiles">
            </div>
            <div class="input-group">
                <label>Unit Price (‚Ç±)</label>
                <input type="number" id="newMaterialPrice" placeholder="0.00" step="0.01">
            </div>
            <div class="input-group">
                <label>Unit</label>
                <select id="newMaterialUnit">
                    <option value="">Select Unit</option>
                    <option value="piece">piece</option>
                    <option value="sqm">sqm</option>
                    <option value="meter">meter</option>
                    <option value="cu.m">cu.m</option>
                    <option value="gallon">gallon</option>
                    <option value="bag">bag</option>
                    <option value="set">set</option>
                    <option value="lot">lot</option>
                    <option value="linear meter">linear meter</option>
                </select>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="addNewMaterial()">Add Material</button>
                <button class="btn btn-secondary" onclick="closeMaterialModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Material Info Modal -->
    <div id="materialInfoModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeMaterialInfoModal()">&times;</span>
            <h2 style="color: #2F4F2F; margin-bottom: 20px;">Material Information & Pricing</h2>
            <div style="background: rgba(154, 205, 50, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="color: #2F4F2F; margin-bottom: 10px;">üìã About Our Material Database</h3>
                <p style="color: #2F4F2F; font-size: 14px; line-height: 1.5; margin-bottom: 10px;">
                    <strong>Philippine Market Prices:</strong> All prices are based on current Philippine market rates (Metro Manila area) as of 2024.
                </p>
                <p style="color: #2F4F2F; font-size: 14px; line-height: 1.5; margin-bottom: 10px;">
                    <strong>Price Range:</strong> These are mid-range quality prices. Budget options may be 20-30% lower, premium options 50-100% higher.
                </p>
                <p style="color: #2F4F2F; font-size: 14px; line-height: 1.5;">
                    <strong>Customizable:</strong> You can edit any price by clicking the ‚úèÔ∏è button next to materials, or add your own materials with custom pricing.
                </p>
            </div>
            <div id="materialInfoContent" style="max-height: 300px; overflow-y: auto;">
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeMaterialInfoModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Edit Material Price Modal -->
    <div id="editPriceModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditPriceModal()">&times;</span>
            <h2 style="color: #2F4F2F; margin-bottom: 20px;">Edit Material Price</h2>
            <div class="input-group">
                <label>Material Name</label>
                <input type="text" id="editMaterialName" readonly style="background: #f3f4f6;">
            </div>
            <div class="input-group">
                <label>Current Price (‚Ç±)</label>
                <input type="number" id="editMaterialPrice" step="0.01">
            </div>
            <div class="input-group">
                <label>Unit</label>
                <input type="text" id="editMaterialUnit" readonly style="background: #f3f4f6;">
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="saveEditedPrice()">Update Price</button>
                <button class="btn btn-secondary" onclick="closeEditPriceModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Data structures
        let boqData = [];
        let summaryData = [];
        let itemCounter = 1;
        let summaryItemCounter = 1;
        let additionalCharges = [];
        let sortDirection = {};
        let categoryChart = null;
        let phaseChart = null;
        let laborChart = null;
        let currentProjectId = null;
        let allProjects = {};
        let marginPercentage = 26;
        let discrepancyPercentage = 10;
        let operationPercentage = 10;
        let contingencyPercentage = 10;
        let discountAmount = 0;
        let vatPercentage = 1;

        // Project phases
        const phases = [
            'Preliminary Works',
            'Structural Works', 
            'Interior Works',
            'Exterior Works',
            'Finishing Works',
            'Other Areas'
        ];

        // Categories
        const categories = [
            'Materials',
            'Labor',
            'Mobilization & Transport',
            'Utilities & Contingencies',
            'Design & Admin',
            'Misc.'
        ];

        // Philippine labor types with rates (sample data)
        const laborTypes = {
            'Skilled Carpenter': { rate: 800, unit: 'day/s' },
            'Mason/Bricklayer': { rate: 750, unit: 'day/s' },
            'Electrician': { rate: 900, unit: 'day/s' },
            'Plumber': { rate: 850, unit: 'day/s' },
            'Painter': { rate: 650, unit: 'day/s' },
            'Tile Setter': { rate: 700, unit: 'day/s' },
            'Welder': { rate: 950, unit: 'day/s' },
            'Helper/Laborer': { rate: 500, unit: 'day/s' },
            'Foreman': { rate: 1200, unit: 'day/s' },
            'Project Manager': { rate: 2500, unit: 'day/s' },
            'Architect Supervision': { rate: 3000, unit: 'day/s' },
            'Engineer Supervision': { rate: 2800, unit: 'day/s' },
            'Safety Officer': { rate: 1000, unit: 'day/s' },
            'Equipment Operator': { rate: 1100, unit: 'day/s' },
            'Demolition Worker': { rate: 600, unit: 'day/s' },
            'Concrete Finisher': { rate: 750, unit: 'day/s' },
            'Roofer': { rate: 800, unit: 'day/s' },
            'Glazier': { rate: 900, unit: 'day/s' },
            'HVAC Technician': { rate: 1000, unit: 'day/s' },
            'Flooring Installer': { rate: 700, unit: 'day/s' }
        };

        // Philippine materials with prices (sample data)
        const materials = {
            // Flooring
            'Ceramic Tiles (60x60cm)': { price: 450, unit: 'sqm' },
            'Vinyl Flooring': { price: 280, unit: 'sqm' },
            'Laminate Flooring': { price: 650, unit: 'sqm' },
            'Hardwood Flooring': { price: 1200, unit: 'sqm' },
            'Marble Tiles': { price: 2500, unit: 'sqm' },
            
            // Paint
            'Latex Paint (Premium)': { price: 1800, unit: 'gallon' },
            'Latex Paint (Standard)': { price: 1200, unit: 'gallon' },
            'Primer': { price: 950, unit: 'gallon' },
            'Texture Paint': { price: 2200, unit: 'gallon' },
            
            // Electrical
            'Electrical Wire 2.0mm': { price: 85, unit: 'meter' },
            'Electrical Wire 3.5mm': { price: 125, unit: 'meter' },
            'Circuit Breaker 20A': { price: 450, unit: 'piece' },
            'Electrical Outlet': { price: 180, unit: 'piece' },
            'Light Switch': { price: 120, unit: 'piece' },
            'LED Downlight 7W': { price: 350, unit: 'piece' },
            
            // Plumbing
            'PVC Pipe 4"': { price: 280, unit: 'meter' },
            'PVC Pipe 2"': { price: 150, unit: 'meter' },
            'Water Closet': { price: 8500, unit: 'piece' },
            'Lavatory': { price: 4500, unit: 'piece' },
            'Kitchen Sink': { price: 3200, unit: 'piece' },
            
            // Ceiling
            'Gypsum Board 12mm': { price: 320, unit: 'sqm' },
            'Metal Furring': { price: 180, unit: 'meter' },
            'Ceiling Tiles': { price: 450, unit: 'sqm' },
            
            // Doors & Windows
            'Hollow Core Door': { price: 3500, unit: 'piece' },
            'Solid Wood Door': { price: 8500, unit: 'piece' },
            'Aluminum Window': { price: 2800, unit: 'sqm' },
            'Door Hardware Set': { price: 1200, unit: 'set' },
            
            // Construction Materials
            'Cement (40kg)': { price: 285, unit: 'bag' },
            'Sand': { price: 1200, unit: 'cu.m' },
            'Gravel': { price: 1800, unit: 'cu.m' },
            'Steel Bar 12mm': { price: 45, unit: 'meter' },
            'Concrete Hollow Blocks': { price: 18, unit: 'piece' }
        };

        // Units
        const units = ['piece', 'sqm', 'meter', 'cu.m', 'gallon', 'bag', 'set', 'lot', 'linear meter', 'day/s', 'elf', 'bag/s', 'roll', 'LS', 'kg'];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing ArtiCentro BOQ System...');
            
            // Force all containers to be visible immediately
            const tableContainer = document.querySelector('.table-container');
            if (tableContainer) {
                tableContainer.style.display = 'block';
                tableContainer.style.visibility = 'visible';
                tableContainer.style.opacity = '1';
            }
            
            // Load saved state first
            loadLogo();
            
            // Initialize tab display properly - force BOQ tab to be visible
            initializeTabs();
            
            // Load projects and data
            loadAllProjects();
            
            // Force initial render with multiple attempts
            setTimeout(() => {
                renderTable();
                renderSummaryTable();
                updateSummary();
                updateDashboard();
                loadLogo(); // Load logo again to ensure it persists
                formatProjectBudget(); // Ensure budget formatting persists
                console.log('Initial render complete');
            }, 50);
            
            setTimeout(() => {
                renderTable();
                renderSummaryTable();
                updateSummary();
                updateDashboard();
                loadLogo();
                formatProjectBudget();
            }, 200);
            
            setTimeout(() => {
                renderTable();
                renderSummaryTable();
                updateSummary();
                updateDashboard();
                loadLogo();
                formatProjectBudget();
            }, 500);
            
            setTimeout(() => {
                formatProjectBudget(); // Final budget formatting attempt
            }, 1000);
            
            // Auto-save every 30 seconds
            setInterval(autoSaveCurrentProject, 30000);
            
            // Add event listeners for project info
            ['projectId', 'projectName', 'clientName', 'projectBudget', 'projectType'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', function() {
                        if (id === 'projectBudget') {
                            formatProjectBudget();
                        }
                        autoSaveCurrentProject();
                    });
                    element.addEventListener('input', function() {
                        if (id === 'projectBudget') {
                            formatProjectBudget();
                        }
                        autoSaveCurrentProject();
                    });
                }
            });
            
            // Handle page visibility changes and refresh events
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden) {
                    setTimeout(() => {
                        loadLogo();
                        renderTable();
                        renderSummaryTable();
                        updateSummary();
                        updateDashboard();
                        initializeTabs();
                    }, 100);
                }
            });
            
            // Handle page refresh/reload
            window.addEventListener('beforeunload', function() {
                autoSaveCurrentProject();
            });
            
            // Handle page load and refresh
            window.addEventListener('load', function() {
                // Clear session storage on fresh load
                sessionStorage.removeItem('logo_loaded');
                
                setTimeout(() => {
                    loadLogo();
                    initializeTabs();
                    renderTable();
                    renderSummaryTable();
                    updateSummary();
                    updateDashboard();
                }, 100);
                
                // Additional logo loading attempts
                setTimeout(() => {
                    loadLogo();
                }, 500);
                
                setTimeout(() => {
                    loadLogo();
                }, 1000);
            });
            
            // Handle page refresh specifically
            window.addEventListener('pageshow', function(event) {
                if (event.persisted) {
                    // Page was loaded from cache (back/forward navigation)
                    sessionStorage.removeItem('logo_loaded');
                    loadLogo();
                    loadAllProjects();
                }
            });
        });

        function initializeTabs() {
            // Get saved active tab or default to BOQ
            const savedActiveTab = localStorage.getItem('articentro_active_tab') || 'boq';
            
            // Initialize all tabs as hidden
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
                tab.style.display = 'none';
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show the saved active tab
            const activeTab = document.getElementById(savedActiveTab + '-tab');
            const activeBtn = document.querySelector(`[onclick="showTab('${savedActiveTab}')"]`);
            
            if (activeTab && activeBtn) {
                activeTab.classList.add('active');
                activeTab.style.display = 'block';
                activeTab.style.visibility = 'visible';
                activeTab.style.opacity = '1';
                activeBtn.classList.add('active');
            } else {
                // Fallback to BOQ tab
                const boqTab = document.getElementById('boq-tab');
                const boqBtn = document.querySelector(`[onclick="showTab('boq')"]`);
                if (boqTab && boqBtn) {
                    boqTab.classList.add('active');
                    boqTab.style.display = 'block';
                    boqTab.style.visibility = 'visible';
                    boqTab.style.opacity = '1';
                    boqBtn.classList.add('active');
                }
            }
            
            // Ensure all table containers are visible
            document.querySelectorAll('.table-container').forEach(container => {
                container.style.display = 'block';
                container.style.visibility = 'visible';
                container.style.opacity = '1';
            });
            
            // Force render based on active tab
            setTimeout(() => {
                if (savedActiveTab === 'dashboard') {
                    updateDashboard();
                } else if (savedActiveTab === 'summary') {
                    renderSummaryTable();
                    updateSummaryTotal();
                } else {
                    renderTable();
                    updateSummary();
                }
            }, 50);
        }

        function formatProjectBudget() {
            const input = document.getElementById('projectBudget');
            if (!input || !input.value) return;
            
            let value = input.value.toString().replace(/,/g, '');
            if (!isNaN(value) && value !== '') {
                const numValue = parseFloat(value);
                if (numValue >= 0) {
                    input.value = numValue.toLocaleString('en-US');
                }
            }
        }

        function parseProjectBudget() {
            const input = document.getElementById('projectBudget');
            if (!input) return 0;
            
            const value = input.value.replace(/,/g, '');
            return parseFloat(value) || 0;
        }

        function addRow() {
            const row = {
                id: Date.now(),
                itemNo: itemCounter++,
                phase: '',
                category: '',
                laborType: '',
                description: '',
                quantity: 0,
                unit: '',
                unitCost: 0,
                totalItemCost: 0,
                discrepancyCost: 0,
                operationCost: 0,
                amount: 0,
                contingencyCost: 0,
                totalAmount: 0,
                marginCost: 0,
                finalAmount: 0,
                supplier: '',
                notes: ''
            };
            
            boqData.push(row);
            renderTable();
            updateSummary();
        }

        function deleteRow(id) {
            boqData = boqData.filter(row => row.id !== id);
            renderTable();
            updateSummary();
            autoSave();
        }

        function duplicateRow(id) {
            const originalRow = boqData.find(row => row.id === id);
            if (originalRow) {
                const newRow = { ...originalRow, id: Date.now(), itemNo: itemCounter++ };
                boqData.push(newRow);
                renderTable();
                updateSummary();
                autoSave();
            }
        }

        function renderTable() {
            const tbody = document.getElementById('boqTableBody');
            tbody.innerHTML = '';
            
            boqData.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.itemNo}</td>
                    <td>
                        <select class="editable" onchange="updateRow(${row.id}, 'phase', this.value)">
                            <option value="">Select Phase</option>
                            ${phases.map(phase => `<option value="${phase}" ${row.phase === phase ? 'selected' : ''}>${phase}</option>`).join('')}
                        </select>
                    </td>
                    <td>
                        <select class="editable" onchange="updateRowCategory(${row.id}, this.value)">
                            <option value="">Select Category</option>
                            ${categories.map(cat => `<option value="${cat}" ${row.category === cat ? 'selected' : ''}>${cat}</option>`).join('')}
                        </select>
                    </td>
                    <td>
                        ${row.category === 'Materials' ? 
                            `<div style="display: flex; gap: 5px; align-items: center;">
                                <select class="editable" onchange="updateMaterial(${row.id}, this.value)" style="flex: 1;">
                                    <option value="">Select Material</option>
                                    ${Object.keys(materials).map(material => 
                                        `<option value="${material}" ${row.description === material ? 'selected' : ''}>${material} (‚Ç±${materials[material].price.toLocaleString('en-PH')}/${materials[material].unit})</option>`
                                    ).join('')}
                                </select>
                                <button onclick="openMaterialModal()" class="btn-add-material" title="Add New Material">‚ûï</button>
                                <button onclick="editMaterialPrice('${row.description}')" class="btn-add-material" title="Edit Price" style="background: #f59e0b;">‚úèÔ∏è</button>
                            </div>` :
                            row.category === 'Labor' ?
                            `<select class="editable" onchange="updateLabor(${row.id}, this.value)">
                                <option value="">Select Labor Type</option>
                                <optgroup label="Labor Charge">
                                    ${Object.keys(laborTypes).map(labor => 
                                        `<option value="Labor charge|${labor}" ${row.laborType === 'Labor charge' && row.description === labor ? 'selected' : ''}>${labor} (‚Ç±${laborTypes[labor].rate.toLocaleString('en-PH')}/${laborTypes[labor].unit})</option>`
                                    ).join('')}
                                </optgroup>
                                <optgroup label="Outsource Labor">
                                    ${Object.keys(laborTypes).map(labor => 
                                        `<option value="Outsource Labor|${labor}" ${row.laborType === 'Outsource Labor' && row.description === labor ? 'selected' : ''}>${labor} (‚Ç±${laborTypes[labor].rate.toLocaleString('en-PH')}/${laborTypes[labor].unit})</option>`
                                    ).join('')}
                                </optgroup>
                                <optgroup label="Project Management">
                                    <option value="Project Management|Project Manager" ${row.laborType === 'Project Management' && row.description === 'Project Manager' ? 'selected' : ''}>Project Manager (‚Ç±${laborTypes['Project Manager'].rate.toLocaleString('en-PH')}/${laborTypes['Project Manager'].unit})</option>
                                    <option value="Project Management|Architect Supervision" ${row.laborType === 'Project Management' && row.description === 'Architect Supervision' ? 'selected' : ''}>Architect Supervision (‚Ç±${laborTypes['Architect Supervision'].rate.toLocaleString('en-PH')}/${laborTypes['Architect Supervision'].unit})</option>
                                    <option value="Project Management|Engineer Supervision" ${row.laborType === 'Project Management' && row.description === 'Engineer Supervision' ? 'selected' : ''}>Engineer Supervision (‚Ç±${laborTypes['Engineer Supervision'].rate.toLocaleString('en-PH')}/${laborTypes['Engineer Supervision'].unit})</option>
                                    <option value="Project Management|Safety Officer" ${row.laborType === 'Project Management' && row.description === 'Safety Officer' ? 'selected' : ''}>Safety Officer (‚Ç±${laborTypes['Safety Officer'].rate.toLocaleString('en-PH')}/${laborTypes['Safety Officer'].unit})</option>
                                </optgroup>
                                <optgroup label="Other/s">
                                    <option value="Other/s|custom" ${row.laborType === 'Other/s' ? 'selected' : ''}>+ Custom Labor</option>
                                </optgroup>
                            </select>` :
                            `<input type="text" class="editable" value="${row.description}" onchange="updateRow(${row.id}, 'description', this.value)" placeholder="Description">`
                        }
                    </td>
                    <td><input type="number" class="editable" value="${row.quantity}" onchange="updateRow(${row.id}, 'quantity', parseFloat(this.value) || 0)" step="0.01"></td>
                    <td>
                        <div style="display: flex; gap: 5px; align-items: center;">
                            <select class="editable" onchange="updateRowUnit(${row.id}, this.value)" style="flex: 1;">
                                <option value="">Unit</option>
                                ${units.map(unit => `<option value="${unit}" ${row.unit === unit ? 'selected' : ''}>${unit}</option>`).join('')}
                                <option value="custom">+ Add Custom</option>
                            </select>
                            <input type="text" class="editable" id="customUnit_${row.id}" value="${row.unit && !units.includes(row.unit) ? row.unit : ''}" onchange="updateRow(${row.id}, 'unit', this.value)" placeholder="Custom unit" style="display: ${row.unit && !units.includes(row.unit) ? 'block' : 'none'}; width: 80px; font-size: 11px;">
                        </div>
                    </td>
                    <td><input type="number" class="editable" value="${row.unitCost}" onchange="updateRow(${row.id}, 'unitCost', parseFloat(this.value) || 0)" step="0.01"></td>
                    <td class="calculated">‚Ç±${row.totalItemCost.toLocaleString('en-PH', {minimumFractionDigits: 2})}</td>
                    <td class="calculated">‚Ç±${row.discrepancyCost.toLocaleString('en-PH', {minimumFractionDigits: 2})}</td>
                    <td class="calculated">‚Ç±${row.operationCost.toLocaleString('en-PH', {minimumFractionDigits: 2})}</td>
                    <td class="calculated">‚Ç±${row.amount.toLocaleString('en-PH', {minimumFractionDigits: 2})}</td>
                    <td class="calculated">‚Ç±${row.contingencyCost.toLocaleString('en-PH', {minimumFractionDigits: 2})}</td>
                    <td class="calculated">‚Ç±${row.totalAmount.toLocaleString('en-PH', {minimumFractionDigits: 2})}</td>
                    <td><input type="text" class="editable" value="${row.supplier}" onchange="updateRow(${row.id}, 'supplier', this.value)" placeholder="Supplier"></td>
                    <td><input type="text" class="editable" value="${row.notes}" onchange="updateRow(${row.id}, 'notes', this.value)" placeholder="Notes"></td>
                    <td>
                        <div class="row-actions">
                            <button class="duplicate-btn" onclick="duplicateRow(${row.id})" title="Duplicate">üìã</button>
                            <button class="delete-btn" onclick="deleteRow(${row.id})" title="Delete">üóëÔ∏è</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            // Add subtotal and total rows
            if (boqData.length > 0) {
                // Calculate totals
                const subtotalCost = boqData.reduce((sum, row) => sum + (row.totalItemCost || 0), 0);
                const subtotalDiscrepancy = boqData.reduce((sum, row) => sum + (row.discrepancyCost || 0), 0);
                const subtotalOperation = boqData.reduce((sum, row) => sum + (row.operationCost || 0), 0);
                const subtotalAmount = boqData.reduce((sum, row) => sum + (row.amount || 0), 0);
                const subtotalContingency = boqData.reduce((sum, row) => sum + (row.contingencyCost || 0), 0);
                const subtotalTotal = boqData.reduce((sum, row) => sum + (row.totalAmount || 0), 0);
                
                // Subtotal row
                const subtotalRow = document.createElement('tr');
                subtotalRow.style.backgroundColor = 'rgba(154, 205, 50, 0.2)';
                subtotalRow.style.fontWeight = 'bold';
                subtotalRow.innerHTML = `
                    <td colspan="7" style="text-align: right; padding: 12px; font-weight: 700; color: #2F4F2F;">SUBTOTAL:</td>
                    <td class="calculated" style="font-weight: 700;">‚Ç±${subtotalCost.toLocaleString('en-PH', {minimumFractionDigits: 2})}</td>
                    <td class="calculated" style="font-weight: 700;">‚Ç±${subtotalDiscrepancy.toLocaleString('en-PH', {minimumFractionDigits: 2})}</td>
                    <td class="calculated" style="font-weight: 700;">‚Ç±${subtotalOperation.toLocaleString('en-PH', {minimumFractionDigits: 2})}</td>
                    <td class="calculated" style="font-weight: 700;">‚Ç±${subtotalAmount.toLocaleString('en-PH', {minimumFractionDigits: 2})}</td>
                    <td class="calculated" style="font-weight: 700;">‚Ç±${subtotalContingency.toLocaleString('en-PH', {minimumFractionDigits: 2})}</td>
                    <td class="calculated" style="font-weight: 700; background: rgba(154, 205, 50, 0.4);">‚Ç±${subtotalTotal.toLocaleString('en-PH', {minimumFractionDigits: 2})}</td>
                    <td colspan="3"></td>
                `;
                tbody.appendChild(subtotalRow);
                
                // Total with margin row
                const marginAmount = subtotalTotal * (marginPercentage / 100);
                const finalTotal = subtotalTotal + marginAmount;
                
                const totalRow = document.createElement('tr');
                totalRow.style.backgroundColor = 'rgba(107, 142, 35, 0.3)';
                totalRow.style.fontWeight = 'bold';
                totalRow.innerHTML = `
                    <td colspan="12" style="text-align: right; padding: 12px; font-weight: 700; color: #2F4F2F;">TOTAL + MARGIN (${marginPercentage}%):</td>
                    <td class="calculated" style="font-weight: 700; background: rgba(107, 142, 35, 0.4); font-size: 14px;">‚Ç±${finalTotal.toLocaleString('en-PH', {minimumFractionDigits: 2})}</td>
                    <td colspan="3"></td>
                `;
                tbody.appendChild(totalRow);
            }
        }

        function updateRow(id, field, value) {
            const row = boqData.find(r => r.id === id);
            if (row) {
                row[field] = value;
                calculateRow(row);
                renderTable();
                updateSummary();
                autoSaveCurrentProject();
            }
        }

        function updateRowCategory(id, value) {
            const row = boqData.find(r => r.id === id);
            if (row) {
                row.category = value;
                if (value !== 'Labor') {
                    row.laborType = ''; // Clear labor type if not labor category
                }
                calculateRow(row);
                renderTable();
                updateSummary();
                autoSaveCurrentProject();
            }
        }

        function updateRowUnit(id, value) {
            const row = boqData.find(r => r.id === id);
            if (row) {
                if (value === 'custom') {
                    // Show custom input field
                    const customInput = document.getElementById(`customUnit_${id}`);
                    if (customInput) {
                        customInput.style.display = 'block';
                        customInput.focus();
                    }
                } else {
                    row.unit = value;
                    calculateRow(row);
                    renderTable();
                    updateSummary();
                    autoSave();
                }
            }
        }

        function updateMaterial(id, materialName) {
            const row = boqData.find(r => r.id === id);
            if (row && materials[materialName]) {
                row.description = materialName;
                row.unitCost = materials[materialName].price;
                row.unit = materials[materialName].unit;
                calculateRow(row);
                renderTable();
                updateSummary();
                autoSaveCurrentProject();
            }
        }

        function updateLabor(id, value) {
            const row = boqData.find(r => r.id === id);
            if (row && value) {
                const [laborType, laborName] = value.split('|');
                
                row.laborType = laborType;
                
                if (laborName === 'custom') {
                    // Allow custom labor input
                    row.description = '';
                    row.unitCost = 0;
                    row.unit = 'day/s';
                } else if (laborTypes[laborName]) {
                    row.description = laborName;
                    row.unitCost = laborTypes[laborName].rate;
                    row.unit = laborTypes[laborName].unit;
                }
                
                calculateRow(row);
                renderTable();
                updateSummary();
                autoSaveCurrentProject();
            }
        }

        function calculateRow(row) {
            // Total Item Cost = Quantity √ó Unit Cost
            row.totalItemCost = row.quantity * row.unitCost;
            
            // Discrepancy Cost = Total Item Cost √ó discrepancy %
            row.discrepancyCost = row.totalItemCost * (discrepancyPercentage / 100);
            
            // Operation Cost = Total Item Cost √ó operation %
            row.operationCost = row.totalItemCost * (operationPercentage / 100);
            
            // Amount = Total Item Cost + Discrepancy Cost + Operation Cost
            row.amount = row.totalItemCost + row.discrepancyCost + row.operationCost;
            
            // Contingency Cost = Amount √ó contingency % (for labor charges)
            row.contingencyCost = row.category === 'Labor' ? row.amount * (contingencyPercentage / 100) : 0;
            
            // Total Amount = Amount + Contingency Cost
            row.totalAmount = row.amount + row.contingencyCost;
        }

        function updateMargin() {
            marginPercentage = parseFloat(document.getElementById('marginInput').value) || 0;
            document.getElementById('marginPercentage').textContent = marginPercentage;
            
            // Update summary margin percentage display
            const summaryMarginElement = document.getElementById('summaryMarginPercentage');
            if (summaryMarginElement) {
                summaryMarginElement.textContent = marginPercentage;
            }
            
            // Recalculate all BOQ rows
            boqData.forEach(row => calculateRow(row));
            
            // Recalculate all summary rows
            summaryData.forEach(row => calculateSummaryRow(row));
            
            renderTable();
            renderSummaryTable();
            updateSummary();
            updateSummaryTotal();
            updateDashboard();
            autoSaveCurrentProject();
        }

        function updateSummary() {
            const baseCost = boqData.reduce((sum, row) => sum + row.finalAmount, 0);
            const additionalCost = additionalCharges.reduce((sum, charge) => sum + charge.amount, 0);
            const totalCost = baseCost + additionalCost;
            const totalItems = boqData.length;
            const projectBudget = parseProjectBudget();
            const budgetUtil = projectBudget > 0 ? (totalCost / projectBudget * 100) : 0;
            const remainingBudget = projectBudget - totalCost;
            
            // Update dashboard elements if they exist
            const totalCostElement = document.getElementById('totalCost');
            if (totalCostElement) {
                totalCostElement.textContent = `‚Ç±${totalCost.toLocaleString('en-PH', {minimumFractionDigits: 2})}`;
            }
            
            const totalItemsElement = document.getElementById('totalItems');
            if (totalItemsElement) {
                totalItemsElement.textContent = totalItems;
            }
            
            const budgetUtilElement = document.getElementById('budgetUtil');
            if (budgetUtilElement) {
                budgetUtilElement.textContent = `${budgetUtil.toFixed(1)}%`;
                
                // Color coding for budget utilization
                if (budgetUtil > 100) {
                    budgetUtilElement.style.color = '#dc2626';
                } else if (budgetUtil > 80) {
                    budgetUtilElement.style.color = '#f59e0b';
                } else {
                    budgetUtilElement.style.color = '#6B8E23';
                }
            }
            
            const remainingElement = document.getElementById('remainingBudget');
            if (remainingElement) {
                remainingElement.textContent = `‚Ç±${remainingBudget.toLocaleString('en-PH', {minimumFractionDigits: 2})}`;
                
                // Color coding for remaining budget
                if (remainingBudget < 0) {
                    remainingElement.style.color = '#dc2626';
                } else if (remainingBudget < projectBudget * 0.1) {
                    remainingElement.style.color = '#f59e0b';
                } else {
                    remainingElement.style.color = '#6B8E23';
                }
            }
        }

        function uploadLogo(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const logoContainer = document.querySelector('.logo');
                    const logoText = document.getElementById('logoText');
                    
                    // Create or update image element
                    let logoImg = logoContainer.querySelector('img');
                    if (!logoImg) {
                        logoImg = document.createElement('img');
                        logoContainer.appendChild(logoImg);
                    }
                    
                    logoImg.src = e.target.result;
                    logoText.style.display = 'none';
                    
                    // Save logo to localStorage
                    localStorage.setItem('articentro_logo', e.target.result);
                };
                reader.readAsDataURL(file);
            }
        }

        function loadLogo() {
            // Multiple attempts to load logo with different timing
            const attemptLoadLogo = (attempt = 1) => {
                const savedLogo = localStorage.getItem('articentro_logo');
                if (savedLogo) {
                    try {
                        const logoContainer = document.querySelector('.logo');
                        const logoText = document.getElementById('logoText');
                        
                        if (logoContainer && logoText) {
                            // Remove existing image if any
                            const existingImg = logoContainer.querySelector('img');
                            if (existingImg) {
                                existingImg.remove();
                            }
                            
                            // Create new image element with better error handling
                            const logoImg = document.createElement('img');
                            logoImg.style.cssText = `
                                width: 100%;
                                height: 100%;
                                object-fit: contain;
                                border-radius: 12px;
                                background: rgba(255, 255, 255, 0.9);
                                position: absolute;
                                top: 0;
                                left: 0;
                                z-index: 2;
                            `;
                            
                            logoImg.onload = function() {
                                logoText.style.display = 'none';
                                console.log('Logo loaded successfully on attempt', attempt);
                                // Store success flag
                                sessionStorage.setItem('logo_loaded', 'true');
                            };
                            
                            logoImg.onerror = function() {
                                console.log('Logo failed to load on attempt', attempt);
                                logoText.style.display = 'block';
                                logoImg.remove();
                                if (attempt >= 3) {
                                    localStorage.removeItem('articentro_logo');
                                    console.log('Logo removed after 3 failed attempts');
                                }
                            };
                            
                            logoImg.src = savedLogo;
                            logoContainer.appendChild(logoImg);
                        }
                    } catch (error) {
                        console.error('Error loading logo on attempt', attempt, ':', error);
                        if (attempt >= 3) {
                            localStorage.removeItem('articentro_logo');
                        }
                    }
                }
            };

            // Try loading immediately
            attemptLoadLogo(1);
            
            // Try again after 100ms if not loaded
            setTimeout(() => {
                if (!sessionStorage.getItem('logo_loaded')) {
                    attemptLoadLogo(2);
                }
            }, 100);
            
            // Final attempt after 500ms
            setTimeout(() => {
                if (!sessionStorage.getItem('logo_loaded')) {
                    attemptLoadLogo(3);
                }
            }, 500);
        }

        function exportToExcel() {
            const projectInfo = {
                'Project ID': document.getElementById('projectId').value,
                'Project Name': document.getElementById('projectName').value,
                'Client Name': document.getElementById('clientName').value,
                'Project Budget': document.getElementById('projectBudget').value,
                'Project Type': document.getElementById('projectType').value
            };
            
            const headers = [
                'Item No.', 'Phase', 'Category', 'Description', 'Quantity', 'Unit', 
                'Unit Cost', 'Total Item Cost', 'Discrepancy Cost', 'Operation Cost', 
                'Amount', 'Contingency Cost', 'Total Amount', 'Supplier', 'Notes'
            ];
            
            const data = boqData.map(row => [
                row.itemNo, row.phase, row.category, row.description, row.quantity, row.unit,
                row.unitCost, row.totalItemCost, row.discrepancyCost, row.operationCost,
                row.amount, row.contingencyCost, row.totalAmount, row.supplier, row.notes
            ]);
            
            const wb = XLSX.utils.book_new();
            
            // Project Info Sheet
            const projectWs = XLSX.utils.json_to_sheet([projectInfo]);
            XLSX.utils.book_append_sheet(wb, projectWs, 'Project Info');
            
            // BOQ Sheet
            const boqWs = XLSX.utils.aoa_to_sheet([headers, ...data]);
            XLSX.utils.book_append_sheet(wb, boqWs, 'BOQ');
            
            const fileName = `BOQ_${document.getElementById('projectId').value || 'Project'}_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        function importFromExcel(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const wb = XLSX.read(e.target.result, { type: 'binary' });
                    const wsName = wb.SheetNames.find(name => name.toLowerCase().includes('boq')) || wb.SheetNames[0];
                    const ws = wb.Sheets[wsName];
                    const data = XLSX.utils.sheet_to_json(ws, { header: 1 });
                    
                    if (data.length > 1) {
                        boqData = [];
                        itemCounter = 1;
                        
                        for (let i = 1; i < data.length; i++) {
                            const rowData = data[i];
                            if (rowData.length > 0 && rowData[0]) {
                                const row = {
                                    id: Date.now() + i,
                                    itemNo: itemCounter++,
                                    phase: rowData[1] || '',
                                    category: rowData[2] || '',
                                    description: rowData[3] || '',
                                    quantity: parseFloat(rowData[4]) || 0,
                                    unit: rowData[5] || '',
                                    unitCost: parseFloat(rowData[6]) || 0,
                                    totalItemCost: 0,
                                    discrepancyCost: 0,
                                    operationCost: 0,
                                    amount: 0,
                                    contingencyCost: 0,
                                    totalAmount: 0,
                                    supplier: rowData[13] || '',
                                    notes: rowData[14] || ''
                                };
                                calculateRow(row);
                                boqData.push(row);
                            }
                        }
                        
                        renderTable();
                        updateSummary();
                        autoSave();
                        alert('Excel file imported successfully!');
                    }
                } catch (error) {
                    alert('Error importing Excel file. Please check the format.');
                    console.error(error);
                }
            };
            reader.readAsBinaryString(file);
            event.target.value = '';
        }

        function saveData() {
            const projectData = {
                projectInfo: {
                    projectId: document.getElementById('projectId').value,
                    projectName: document.getElementById('projectName').value,
                    clientName: document.getElementById('clientName').value,
                    projectBudget: document.getElementById('projectBudget').value,
                    projectType: document.getElementById('projectType').value
                },
                boqData: boqData,
                additionalCharges: additionalCharges,
                itemCounter: itemCounter,
                timestamp: new Date().toISOString()
            };
            
            localStorage.setItem('articentro_boq_data', JSON.stringify(projectData));
            
            // Also create downloadable backup
            const dataStr = JSON.stringify(projectData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `BOQ_Backup_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            alert('Data saved successfully!');
        }

        function loadData() {
            const savedData = localStorage.getItem('articentro_boq_data');
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    
                    // Load project info
                    if (data.projectInfo) {
                        document.getElementById('projectId').value = data.projectInfo.projectId || '';
                        document.getElementById('projectName').value = data.projectInfo.projectName || '';
                        document.getElementById('clientName').value = data.projectInfo.clientName || '';
                        document.getElementById('projectBudget').value = data.projectInfo.projectBudget || '';
                        document.getElementById('projectType').value = data.projectInfo.projectType || '';
                    }
                    
                    // Load BOQ data
                    boqData = data.boqData || [];
                    additionalCharges = data.additionalCharges || [];
                    itemCounter = data.itemCounter || 1;
                    
                    renderTable();
                    renderAdditionalCharges();
                    updateSummary();
                    updateDashboard();
                } catch (error) {
                    console.error('Error loading data:', error);
                }
            }
        }

        // Project Management Functions
        function createNewProject() {
            const projectName = prompt('Enter project name:');
            if (projectName && projectName.trim()) {
                const projectId = 'AC-' + Date.now();
                
                // Save current project if exists
                if (currentProjectId) {
                    saveCurrentProject();
                }
                
                // Create new project
                currentProjectId = projectId;
                boqData = [];
                additionalCharges = [];
                itemCounter = 1;
                
                // Set project info
                document.getElementById('projectId').value = projectId;
                document.getElementById('projectName').value = projectName.trim();
                document.getElementById('clientName').value = '';
                document.getElementById('projectBudget').value = '';
                document.getElementById('projectType').value = '';
                
                // Add first row
                addRow();
                
                // Update UI
                updateProjectSelector();
                renderTable();
                updateSummary();
                updateDashboard();
                
                alert(`New project "${projectName}" created successfully!`);
            }
        }

        function switchProject() {
            const selectedProjectId = document.getElementById('projectSelector').value;
            if (selectedProjectId && selectedProjectId !== currentProjectId) {
                // Save current project
                if (currentProjectId) {
                    saveCurrentProject();
                }
                
                // Force complete data reset
                boqData = [];
                additionalCharges = [];
                itemCounter = 1;
                
                // Clear all UI elements immediately
                const tbody = document.getElementById('boqTableBody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="16" style="text-align: center; padding: 20px; color: #6b7280;">Loading project data...</td></tr>';
                }
                
                // Clear project info fields
                document.getElementById('projectId').value = '';
                document.getElementById('projectName').value = '';
                document.getElementById('clientName').value = '';
                document.getElementById('projectBudget').value = '';
                document.getElementById('projectType').value = '';
                
                // Clear additional charges
                const chargesContainer = document.getElementById('additionalChargesList');
                if (chargesContainer) {
                    chargesContainer.innerHTML = '';
                }
                
                // Load selected project with multiple attempts
                setTimeout(() => {
                    loadProject(selectedProjectId);
                    
                    // Force additional refreshes
                    setTimeout(() => {
                        renderTable();
                        renderAdditionalCharges();
                        updateSummary();
                        updateDashboard();
                        renderSummaryTable();
                    }, 100);
                    
                    setTimeout(() => {
                        renderTable();
                        renderAdditionalCharges();
                        updateSummary();
                        updateDashboard();
                        renderSummaryTable();
                    }, 300);
                }, 50);
            }
        }

        function loadProject(projectId) {
            const savedProjects = JSON.parse(localStorage.getItem('articentro_all_projects') || '{}');
            const project = savedProjects[projectId];
            
            if (project) {
                currentProjectId = projectId;
                
                // Load project info with proper budget handling
                document.getElementById('projectId').value = project.projectInfo.projectId || '';
                document.getElementById('projectName').value = project.projectInfo.projectName || '';
                document.getElementById('clientName').value = project.projectInfo.clientName || '';
                
                // Handle project budget properly - preserve the raw value and format it
                const budgetValue = project.projectInfo.projectBudget || '';
                const budgetInput = document.getElementById('projectBudget');
                
                // Set the budget value directly first
                budgetInput.value = budgetValue;
                
                // Format budget with multiple attempts to ensure it persists
                if (budgetValue && budgetValue.toString().trim() !== '') {
                    // Store the original value temporarily
                    const originalValue = budgetValue.toString();
                    
                    // Format immediately
                    setTimeout(() => {
                        const numericValue = originalValue.replace(/,/g, '');
                        if (!isNaN(numericValue) && numericValue !== '') {
                            const formattedValue = parseFloat(numericValue).toLocaleString('en-US');
                            budgetInput.value = formattedValue;
                        }
                    }, 10);
                    
                    // Additional formatting attempts
                    setTimeout(() => {
                        if (budgetInput.value !== originalValue && !budgetInput.value.includes(',')) {
                            const numericValue = originalValue.replace(/,/g, '');
                            if (!isNaN(numericValue) && numericValue !== '') {
                                const formattedValue = parseFloat(numericValue).toLocaleString('en-US');
                                budgetInput.value = formattedValue;
                            }
                        }
                    }, 100);
                    
                    setTimeout(() => {
                        if (budgetInput.value !== originalValue && !budgetInput.value.includes(',')) {
                            const numericValue = originalValue.replace(/,/g, '');
                            if (!isNaN(numericValue) && numericValue !== '') {
                                const formattedValue = parseFloat(numericValue).toLocaleString('en-US');
                                budgetInput.value = formattedValue;
                            }
                        }
                    }, 300);
                }
                
                document.getElementById('projectType').value = project.projectInfo.projectType || '';
                
                // Load project data - ensure fresh data
                boqData = JSON.parse(JSON.stringify(project.boqData || []));
                summaryData = JSON.parse(JSON.stringify(project.summaryData || []));
                additionalCharges = JSON.parse(JSON.stringify(project.additionalCharges || []));
                itemCounter = project.itemCounter || 1;
                summaryItemCounter = project.summaryItemCounter || 1;
                
                // Load percentages and discount
                marginPercentage = project.marginPercentage || 26;
                discrepancyPercentage = project.discrepancyPercentage || 10;
                operationPercentage = project.operationPercentage || 10;
                contingencyPercentage = project.contingencyPercentage || 10;
                discountAmount = project.discountAmount || 0;
                vatPercentage = project.vatPercentage || 1;
                
                // Update UI elements
                document.getElementById('marginInput').value = marginPercentage;
                document.getElementById('marginPercentage').textContent = marginPercentage;
                document.getElementById('discrepancyPercentage').textContent = discrepancyPercentage;
                document.getElementById('operationPercentage').textContent = operationPercentage;
                document.getElementById('contingencyPercentage').textContent = contingencyPercentage;
                document.getElementById('discountAmount').value = discountAmount;
                document.getElementById('vatPercentage').textContent = vatPercentage;
                document.getElementById('dashVatPercentage').textContent = vatPercentage;
                
                // Format project budget with commas after a short delay - multiple attempts
                setTimeout(() => {
                    const budgetInput = document.getElementById('projectBudget');
                    if (budgetInput && budgetInput.value) {
                        formatProjectBudget();
                    }
                }, 100);
                
                setTimeout(() => {
                    const budgetInput = document.getElementById('projectBudget');
                    if (budgetInput && budgetInput.value && !budgetInput.value.includes(',')) {
                        formatProjectBudget();
                    }
                }, 300);
                
                setTimeout(() => {
                    const budgetInput = document.getElementById('projectBudget');
                    if (budgetInput && budgetInput.value && !budgetInput.value.includes(',')) {
                        formatProjectBudget();
                    }
                }, 600);
                
                // Force all containers to be visible
                const tableContainer = document.querySelector('.table-container');
                if (tableContainer) {
                    tableContainer.style.display = 'block';
                    tableContainer.style.visibility = 'visible';
                    tableContainer.style.opacity = '1';
                }
                
                const boqTab = document.getElementById('boq-tab');
                if (boqTab) {
                    boqTab.style.display = 'block';
                    boqTab.style.visibility = 'visible';
                }
                
                // Clear and rebuild everything completely
                const tbody = document.getElementById('boqTableBody');
                if (tbody) {
                    tbody.innerHTML = '';
                }
                
                const summaryTbody = document.getElementById('summaryTableBody');
                if (summaryTbody) {
                    summaryTbody.innerHTML = '';
                }
                
                // Force immediate UI updates with multiple refresh cycles
                renderTable();
                renderSummaryTable();
                renderAdditionalCharges();
                updateSummary();
                updateSummaryTotal();
                updateDashboard();
                
                // Additional refresh cycles to ensure everything loads
                setTimeout(() => {
                    renderTable();
                    renderSummaryTable();
                    updateSummary();
                    updateSummaryTotal();
                    updateDashboard();
                }, 50);
                
                setTimeout(() => {
                    renderTable();
                    renderSummaryTable();
                    updateSummary();
                    updateSummaryTotal();
                    updateDashboard();
                }, 200);
                
                setTimeout(() => {
                    renderTable();
                    renderSummaryTable();
                    updateSummary();
                    updateSummaryTotal();
                    updateDashboard();
                }, 500);
                
                console.log('Project loaded:', projectId, 'BOQ items:', boqData.length, 'Summary items:', summaryData.length);
            }
        }

        function saveCurrentProject() {
            if (!currentProjectId) return;
            
            const projectData = {
                projectInfo: {
                    projectId: document.getElementById('projectId').value,
                    projectName: document.getElementById('projectName').value,
                    clientName: document.getElementById('clientName').value,
                    projectBudget: document.getElementById('projectBudget').value,
                    projectType: document.getElementById('projectType').value
                },
                boqData: boqData,
                summaryData: summaryData,
                additionalCharges: additionalCharges,
                itemCounter: itemCounter,
                summaryItemCounter: summaryItemCounter,
                marginPercentage: marginPercentage,
                discrepancyPercentage: discrepancyPercentage,
                operationPercentage: operationPercentage,
                contingencyPercentage: contingencyPercentage,
                discountAmount: discountAmount,
                vatPercentage: vatPercentage,
                timestamp: new Date().toISOString()
            };
            
            const savedProjects = JSON.parse(localStorage.getItem('articentro_all_projects') || '{}');
            savedProjects[currentProjectId] = projectData;
            localStorage.setItem('articentro_all_projects', JSON.stringify(savedProjects));
        }

        function autoSaveCurrentProject() {
            if (currentProjectId) {
                saveCurrentProject();
            }
        }

        function loadAllProjects() {
            const savedProjects = JSON.parse(localStorage.getItem('articentro_all_projects') || '{}');
            allProjects = savedProjects;
            
            updateProjectSelector();
            
            // Load first project if available
            const projectIds = Object.keys(savedProjects);
            if (projectIds.length > 0) {
                // Set the selector to the first project and load it
                document.getElementById('projectSelector').value = projectIds[0];
                loadProject(projectIds[0]);
            } else {
                // Initialize empty state - ensure table is visible
                boqData = [];
                additionalCharges = [];
                itemCounter = 1;
                currentProjectId = null;
                
                // Force table and containers to show
                const tableContainer = document.querySelector('.table-container');
                if (tableContainer) {
                    tableContainer.style.display = 'block';
                    tableContainer.style.visibility = 'visible';
                    tableContainer.style.opacity = '1';
                }
                
                const boqTab = document.getElementById('boq-tab');
                if (boqTab) {
                    boqTab.style.display = 'block';
                    boqTab.style.visibility = 'visible';
                }
                
                renderTable();
                updateSummary();
                updateDashboard();
            }
        }

        function updateProjectSelector() {
            const selector = document.getElementById('projectSelector');
            selector.innerHTML = '<option value="">Select Project</option>';
            
            Object.entries(allProjects).forEach(([projectId, project]) => {
                const option = document.createElement('option');
                option.value = projectId;
                option.textContent = `${project.projectInfo.projectName || 'Unnamed Project'} (${project.projectInfo.projectId || projectId})`;
                if (projectId === currentProjectId) {
                    option.selected = true;
                }
                selector.appendChild(option);
            });
        }

        function duplicateProject() {
            if (!currentProjectId) {
                alert('Please select a project to duplicate.');
                return;
            }
            
            const newProjectName = prompt('Enter name for duplicated project:');
            if (newProjectName && newProjectName.trim()) {
                const newProjectId = 'AC-' + Date.now();
                
                // Save current project
                saveCurrentProject();
                
                // Create duplicate
                const currentProject = allProjects[currentProjectId];
                const duplicatedProject = JSON.parse(JSON.stringify(currentProject));
                
                // Update project info
                duplicatedProject.projectInfo.projectId = newProjectId;
                duplicatedProject.projectInfo.projectName = newProjectName.trim();
                duplicatedProject.timestamp = new Date().toISOString();
                
                // Save duplicated project
                allProjects[newProjectId] = duplicatedProject;
                const savedProjects = JSON.parse(localStorage.getItem('articentro_all_projects') || '{}');
                savedProjects[newProjectId] = duplicatedProject;
                localStorage.setItem('articentro_all_projects', JSON.stringify(savedProjects));
                
                // Load duplicated project
                loadProject(newProjectId);
                updateProjectSelector();
                
                alert(`Project duplicated as "${newProjectName}" successfully!`);
            }
        }

        function deleteProject() {
            if (!currentProjectId) {
                alert('Please select a project to delete.');
                return;
            }
            
            const projectName = document.getElementById('projectName').value || 'this project';
            if (confirm(`Are you sure you want to delete "${projectName}"? This action cannot be undone.`)) {
                // Remove from storage
                const savedProjects = JSON.parse(localStorage.getItem('articentro_all_projects') || '{}');
                delete savedProjects[currentProjectId];
                delete allProjects[currentProjectId];
                localStorage.setItem('articentro_all_projects', JSON.stringify(savedProjects));
                
                // Load another project or create new one
                const remainingProjects = Object.keys(savedProjects);
                if (remainingProjects.length > 0) {
                    loadProject(remainingProjects[0]);
                } else {
                    // No projects left, create new one
                    currentProjectId = null;
                    createNewProject();
                }
                
                updateProjectSelector();
                alert('Project deleted successfully!');
            }
        }

        // Material price editing functions
        function editMaterialPrice(materialName) {
            if (!materialName || !materials[materialName]) {
                alert('Please select a valid material first.');
                return;
            }
            
            document.getElementById('editMaterialName').value = materialName;
            document.getElementById('editMaterialPrice').value = materials[materialName].price;
            document.getElementById('editMaterialUnit').value = materials[materialName].unit;
            document.getElementById('editPriceModal').style.display = 'block';
        }

        function closeEditPriceModal() {
            document.getElementById('editPriceModal').style.display = 'none';
        }

        function saveEditedPrice() {
            const materialName = document.getElementById('editMaterialName').value;
            const newPrice = parseFloat(document.getElementById('editMaterialPrice').value);
            
            if (materialName && newPrice > 0) {
                materials[materialName].price = newPrice;
                
                // Update any existing rows using this material
                boqData.forEach(row => {
                    if (row.description === materialName) {
                        row.unitCost = newPrice;
                        calculateRow(row);
                    }
                });
                
                renderTable();
                updateSummary();
                updateDashboard();
                closeEditPriceModal();
                autoSaveCurrentProject();
                
                alert(`Price for "${materialName}" updated to ‚Ç±${newPrice.toLocaleString('en-PH', {minimumFractionDigits: 2})}!`);
            } else {
                alert('Please enter a valid price.');
            }
        }

        function closeMaterialInfoModal() {
            document.getElementById('materialInfoModal').style.display = 'none';
        }

        function clearAll() {
            if (confirm('Are you sure you want to clear all data? This action cannot be undone.')) {
                boqData = [];
                additionalCharges = [];
                itemCounter = 1;
                document.getElementById('projectId').value = '';
                document.getElementById('projectName').value = '';
                document.getElementById('clientName').value = '';
                document.getElementById('projectBudget').value = '';
                document.getElementById('projectType').value = '';
                renderTable();
                renderAdditionalCharges();
                updateSummary();
                updateDashboard();
                localStorage.removeItem('articentro_boq_data');
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 's':
                        e.preventDefault();
                        autoSave();
                        break;
                    case 'n':
                        e.preventDefault();
                        addRow();
                        break;
                }
            }
        });

        // Tab switching functionality
        function showTab(tabName) {
            // Save active tab to localStorage
            localStorage.setItem('articentro_active_tab', tabName);
            
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
                tab.style.display = 'none';
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab content
            const selectedTab = document.getElementById(tabName + '-tab');
            if (selectedTab) {
                selectedTab.classList.add('active');
                selectedTab.style.display = 'block';
            }
            
            // Add active class to clicked tab button
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // Fallback for programmatic calls
                const tabBtn = document.querySelector(`[onclick="showTab('${tabName}')"]`);
                if (tabBtn) {
                    tabBtn.classList.add('active');
                }
            }
            
            // Update content based on tab with multiple refresh attempts
            setTimeout(() => {
                if (tabName === 'dashboard') {
                    updateDashboard();
                } else if (tabName === 'summary') {
                    renderSummaryTable();
                    updateSummaryTotal();
                } else if (tabName === 'boq') {
                    renderTable();
                    updateSummary();
                }
            }, 50);
            
            setTimeout(() => {
                if (tabName === 'dashboard') {
                    updateDashboard();
                } else if (tabName === 'summary') {
                    renderSummaryTable();
                    updateSummaryTotal();
                } else if (tabName === 'boq') {
                    renderTable();
                    updateSummary();
                }
            }, 200);
        }

        // Additional charges management
        function addAdditionalCharge() {
            const description = document.getElementById('newChargeDescription').value.trim();
            const amount = parseFloat(document.getElementById('newChargeAmount').value) || 0;
            
            if (description && amount > 0) {
                const charge = {
                    id: Date.now(),
                    description: description,
                    amount: amount
                };
                
                additionalCharges.push(charge);
                renderAdditionalCharges();
                updateDashboard();
                
                // Clear inputs
                document.getElementById('newChargeDescription').value = '';
                document.getElementById('newChargeAmount').value = '';
                
                autoSave();
            } else {
                alert('Please enter both description and amount for the additional charge.');
            }
        }

        function removeAdditionalCharge(id) {
            additionalCharges = additionalCharges.filter(charge => charge.id !== id);
            renderAdditionalCharges();
            updateDashboard();
            autoSave();
        }

        function renderAdditionalCharges() {
            const container = document.getElementById('additionalChargesList');
            container.innerHTML = '';
            
            additionalCharges.forEach(charge => {
                const chargeDiv = document.createElement('div');
                chargeDiv.className = 'charge-input';
                chargeDiv.innerHTML = `
                    <input type="text" value="${charge.description}" readonly style="background: rgba(154, 205, 50, 0.1);">
                    <input type="number" value="${charge.amount}" readonly style="background: rgba(154, 205, 50, 0.1);">
                    <button onclick="removeAdditionalCharge(${charge.id})" title="Remove">üóëÔ∏è</button>
                `;
                container.appendChild(chargeDiv);
            });
        }

        // Dashboard update functions
        function updateDashboard() {
            updateFinancialSummary();
            updateCategoryBreakdown();
            updatePhaseBreakdown();
            updateLaborBreakdown();
        }

        function updateFinancialSummary() {
            const totalCostFromBOQ = boqData.reduce((sum, row) => sum + (row.totalAmount || 0), 0);
            const marginCost = totalCostFromBOQ * (marginPercentage / 100);
            const additionalCost = additionalCharges.reduce((sum, charge) => sum + (charge.amount || 0), 0);
            const subtotal = totalCostFromBOQ + marginCost + additionalCost - discountAmount;
            const vatAmount = subtotal * (vatPercentage / 100);
            const grandTotal = subtotal + vatAmount;
            const projectBudget = parseProjectBudget();
            const remainingBudget = projectBudget - grandTotal;
            const budgetUtilization = projectBudget > 0 ? (grandTotal / projectBudget * 100) : 0;
            
            document.getElementById('dashBaseCost').textContent = `‚Ç±${totalCostFromBOQ.toLocaleString('en-PH', {minimumFractionDigits: 2})}`;
            document.getElementById('dashMarginAmount').textContent = `‚Ç±${marginCost.toLocaleString('en-PH', {minimumFractionDigits: 2})}`;
            document.getElementById('dashMarginPercentage').textContent = marginPercentage;
            document.getElementById('dashAdditionalCharges').textContent = `‚Ç±${additionalCost.toLocaleString('en-PH', {minimumFractionDigits: 2})}`;
            document.getElementById('dashDiscount').textContent = `‚Ç±${discountAmount.toLocaleString('en-PH', {minimumFractionDigits: 2})}`;
            document.getElementById('dashVatAmount').textContent = `‚Ç±${vatAmount.toLocaleString('en-PH', {minimumFractionDigits: 2})}`;
            document.getElementById('dashVatPercentage').textContent = vatPercentage;
            document.getElementById('dashGrandTotal').textContent = `‚Ç±${grandTotal.toLocaleString('en-PH', {minimumFractionDigits: 2})}`;
            document.getElementById('dashRemainingBudget').textContent = `‚Ç±${remainingBudget.toLocaleString('en-PH', {minimumFractionDigits: 2})}`;
            document.getElementById('budgetUtil').textContent = `${budgetUtilization.toFixed(1)}%`;
            
            // Color coding for remaining budget
            const remainingElement = document.getElementById('dashRemainingBudget');
            if (remainingBudget < 0) {
                remainingElement.style.color = '#dc2626';
            } else if (remainingBudget < projectBudget * 0.1) {
                remainingElement.style.color = '#f59e0b';
            } else {
                remainingElement.style.color = '#6B8E23';
            }
            
            // Color coding for budget utilization
            const budgetUtilElement = document.getElementById('budgetUtil');
            if (budgetUtilization > 100) {
                budgetUtilElement.style.color = '#dc2626';
            } else if (budgetUtilization > 80) {
                budgetUtilElement.style.color = '#f59e0b';
            } else {
                budgetUtilElement.style.color = '#6B8E23';
            }
        }

        function updateCategoryBreakdown() {
            const categoryTotals = {};
            const totalCost = boqData.reduce((sum, row) => sum + row.totalAmount, 0);
            
            // Initialize categories
            categories.forEach(category => {
                categoryTotals[category] = 0;
            });
            
            // Calculate totals by category
            boqData.forEach(row => {
                if (row.category && categoryTotals.hasOwnProperty(row.category)) {
                    categoryTotals[row.category] += row.totalAmount;
                }
            });
            
            // Create pie chart
            const chartData = categories.map(cat => categoryTotals[cat]);
            createPieChart('categoryChart', chartData, categories, 'Category Breakdown');
            
            // Render category breakdown
            const container = document.getElementById('categoryBreakdown');
            container.innerHTML = '';
            
            Object.entries(categoryTotals).forEach(([category, amount]) => {
                const percentage = totalCost > 0 ? (amount / totalCost * 100) : 0;
                
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'category-item';
                categoryDiv.innerHTML = `
                    <h4>${category}</h4>
                    <div class="amount">‚Ç±${amount.toLocaleString('en-PH', {minimumFractionDigits: 2})}</div>
                    <div class="percentage">${percentage.toFixed(1)}% of total</div>
                `;
                container.appendChild(categoryDiv);
            });
        }

        function updatePhaseBreakdown() {
            const phaseTotals = {};
            const totalCost = boqData.reduce((sum, row) => sum + row.totalAmount, 0);
            
            // Initialize phases
            phases.forEach(phase => {
                phaseTotals[phase] = 0;
            });
            
            // Calculate totals by phase
            boqData.forEach(row => {
                if (row.phase && phaseTotals.hasOwnProperty(row.phase)) {
                    phaseTotals[row.phase] += row.totalAmount;
                }
            });
            
            // Create pie chart
            const chartData = phases.map(phase => phaseTotals[phase]);
            createPieChart('phaseChart', chartData, phases, 'Phase Breakdown');
            
            // Render phase breakdown
            const container = document.getElementById('phaseBreakdown');
            container.innerHTML = '';
            
            Object.entries(phaseTotals).forEach(([phase, amount]) => {
                const percentage = totalCost > 0 ? (amount / totalCost * 100) : 0;
                
                const phaseDiv = document.createElement('div');
                phaseDiv.className = 'category-item';
                phaseDiv.innerHTML = `
                    <h4>${phase}</h4>
                    <div class="amount">‚Ç±${amount.toLocaleString('en-PH', {minimumFractionDigits: 2})}</div>
                    <div class="percentage">${percentage.toFixed(1)}% of total</div>
                `;
                container.appendChild(phaseDiv);
            });
        }

        function updateLaborBreakdown() {
            const laborTypes = ['Labor charge', 'Outsource Labor', 'Project Management', 'Other/s'];
            const laborTotals = {};
            const totalLaborCost = boqData.filter(row => row.category === 'Labor').reduce((sum, row) => sum + row.totalAmount, 0);
            
            // Initialize labor types
            laborTypes.forEach(type => {
                laborTotals[type] = 0;
            });
            
            // Calculate totals by labor type
            boqData.forEach(row => {
                if (row.category === 'Labor' && row.laborType && laborTotals.hasOwnProperty(row.laborType)) {
                    laborTotals[row.laborType] += row.totalAmount;
                }
            });
            
            // Create pie chart
            const chartData = laborTypes.map(type => laborTotals[type]);
            createPieChart('laborChart', chartData, laborTypes, 'Labor Breakdown');
            
            // Render labor breakdown
            const container = document.getElementById('laborBreakdown');
            container.innerHTML = '';
            
            if (totalLaborCost === 0) {
                container.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 20px;">No labor costs recorded yet</p>';
                return;
            }
            
            Object.entries(laborTotals).forEach(([type, amount]) => {
                const percentage = totalLaborCost > 0 ? (amount / totalLaborCost * 100) : 0;
                
                if (amount > 0) {
                    const laborDiv = document.createElement('div');
                    laborDiv.className = 'category-item';
                    laborDiv.innerHTML = `
                        <h4>${type}</h4>
                        <div class="amount">‚Ç±${amount.toLocaleString('en-PH', {minimumFractionDigits: 2})}</div>
                        <div class="percentage">${percentage.toFixed(1)}% of labor costs</div>
                    `;
                    container.appendChild(laborDiv);
                }
            });
        }

        // Sorting functionality
        function sortTable(field) {
            // Toggle sort direction
            sortDirection[field] = sortDirection[field] === 'asc' ? 'desc' : 'asc';
            
            // Update header indicators
            document.querySelectorAll('th').forEach(th => {
                th.classList.remove('sorted-asc', 'sorted-desc');
            });
            
            const header = document.querySelector(`th[onclick="sortTable('${field}')"]`);
            if (header) {
                header.classList.add(sortDirection[field] === 'asc' ? 'sorted-asc' : 'sorted-desc');
            }
            
            // Sort the data
            boqData.sort((a, b) => {
                let aVal = a[field];
                let bVal = b[field];
                
                // Handle numeric fields
                if (['itemNo', 'quantity', 'unitCost', 'totalItemCost', 'totalAmount'].includes(field)) {
                    aVal = parseFloat(aVal) || 0;
                    bVal = parseFloat(bVal) || 0;
                } else {
                    // Handle string fields
                    aVal = String(aVal).toLowerCase();
                    bVal = String(bVal).toLowerCase();
                }
                
                if (sortDirection[field] === 'asc') {
                    return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                } else {
                    return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
                }
            });
            
            renderTable();
        }

        // Material management functions
        function openMaterialModal() {
            document.getElementById('materialModal').style.display = 'block';
        }

        function closeMaterialModal() {
            document.getElementById('materialModal').style.display = 'none';
            document.getElementById('newMaterialName').value = '';
            document.getElementById('newMaterialPrice').value = '';
            document.getElementById('newMaterialUnit').value = '';
        }

        function addNewMaterial() {
            const name = document.getElementById('newMaterialName').value.trim();
            const price = parseFloat(document.getElementById('newMaterialPrice').value) || 0;
            const unit = document.getElementById('newMaterialUnit').value;
            
            if (name && price > 0 && unit) {
                materials[name] = { price: price, unit: unit };
                closeMaterialModal();
                renderTable(); // Refresh table to show new material in dropdowns
                autoSave();
                alert(`Material "${name}" added successfully!`);
            } else {
                alert('Please fill in all fields with valid values.');
            }
        }

        // Chart creation functions
        function createPieChart(canvasId, data, labels, title) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (data.length === 0 || data.every(val => val === 0)) {
                ctx.fillStyle = '#2F4F2F';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('No data available', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            const total = data.reduce((sum, val) => sum + val, 0);
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2 - 30; // Move chart up to make room for legend
            const radius = Math.min(centerX, centerY) - 20;
            
            const colors = [
                '#dc2626', '#2563eb', '#f59e0b', '#7c3aed', 
                '#059669', '#db2777', '#ea580c', '#0891b2'
            ];
            
            let currentAngle = -Math.PI / 2;
            
            // Draw pie slices
            data.forEach((value, index) => {
                if (value > 0) {
                    const sliceAngle = (value / total) * 2 * Math.PI;
                    
                    ctx.beginPath();
                    ctx.moveTo(centerX, centerY);
                    ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                    ctx.closePath();
                    ctx.fillStyle = colors[index % colors.length];
                    ctx.fill();
                    ctx.strokeStyle = '#ffffff';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    
                    // Draw percentage labels on slices
                    const labelAngle = currentAngle + sliceAngle / 2;
                    const labelX = centerX + Math.cos(labelAngle) * (radius * 0.7);
                    const labelY = centerY + Math.sin(labelAngle) * (radius * 0.7);
                    
                    ctx.fillStyle = '#ffffff';
                    ctx.font = 'bold 11px Arial';
                    ctx.textAlign = 'center';
                    const percentage = ((value / total) * 100).toFixed(1);
                    if (percentage >= 5) { // Only show percentage if slice is large enough
                        ctx.fillText(`${percentage}%`, labelX, labelY);
                    }
                    
                    currentAngle += sliceAngle;
                }
            });
            
            // Draw legend at the bottom of the chart
            const activeLabels = labels.filter((label, index) => data[index] > 0);
            const legendStartY = canvas.height - 60;
            const legendItemWidth = Math.min(120, canvas.width / Math.max(activeLabels.length, 1));
            let legendIndex = 0;
            
            labels.forEach((label, index) => {
                if (data[index] > 0) {
                    const legendX = (legendIndex * legendItemWidth) + 20;
                    
                    // Draw colored rectangle
                    ctx.fillStyle = colors[index % colors.length];
                    ctx.fillRect(legendX, legendStartY, 12, 12);
                    
                    // Draw label text
                    ctx.fillStyle = '#2F4F2F';
                    ctx.font = '10px Arial';
                    ctx.textAlign = 'left';
                    ctx.fillText(label.substring(0, 12), legendX + 16, legendStartY + 9);
                    
                    legendIndex++;
                }
            });
        }

        // Summary table functions
        function addSummaryRow() {
            const row = {
                id: Date.now(),
                itemNo: summaryItemCounter,
                description: '',
                quantity: 0,
                unit: '',
                totalCost: 0,
                marginCost: 0,
                totalAmount: 0
            };
            
            summaryData.push(row);
            summaryItemCounter++;
            renderSummaryTable();
            updateSummaryTotal();
            autoSaveCurrentProject();
        }

        function deleteSummaryRow(id) {
            summaryData = summaryData.filter(row => row.id !== id);
            renderSummaryTable();
            updateSummaryTotal();
            autoSaveCurrentProject();
        }

        function duplicateSummaryRow(id) {
            const originalRow = summaryData.find(row => row.id === id);
            if (originalRow) {
                const newRow = { ...originalRow, id: Date.now(), itemNo: summaryItemCounter };
                summaryData.push(newRow);
                summaryItemCounter++;
                renderSummaryTable();
                updateSummaryTotal();
                autoSaveCurrentProject();
            }
        }

        function updateSummaryRow(id, field, value) {
            const row = summaryData.find(r => r.id === id);
            if (row) {
                row[field] = value;
                calculateSummaryRow(row);
                renderSummaryTable();
                updateSummaryTotal();
                autoSaveCurrentProject();
            }
        }

        function calculateSummaryRow(row) {
            // Margin Cost = Total Cost √ó margin %
            row.marginCost = row.totalCost * (marginPercentage / 100);
            
            // Total Amount = Total Cost + Margin Cost
            row.totalAmount = row.totalCost + row.marginCost;
        }

        function renderSummaryTable() {
            const tbody = document.getElementById('summaryTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            summaryData.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.itemNo}</td>
                    <td><input type="text" class="editable" value="${row.description}" onchange="updateSummaryRow(${row.id}, 'description', this.value)" placeholder="Description"></td>
                    <td><input type="number" class="editable" value="${row.quantity}" onchange="updateSummaryRow(${row.id}, 'quantity', parseFloat(this.value) || 0)" step="0.01"></td>
                    <td>
                        <select class="editable" onchange="updateSummaryRow(${row.id}, 'unit', this.value)">
                            <option value="">Unit</option>
                            ${units.map(unit => `<option value="${unit}" ${row.unit === unit ? 'selected' : ''}>${unit}</option>`).join('')}
                        </select>
                    </td>
                    <td><input type="number" class="editable" value="${row.totalCost}" onchange="updateSummaryRow(${row.id}, 'totalCost', parseFloat(this.value) || 0)" step="0.01"></td>
                    <td class="calculated">‚Ç±${row.marginCost.toLocaleString('en-PH', {minimumFractionDigits: 2})}</td>
                    <td class="calculated">‚Ç±${row.totalAmount.toLocaleString('en-PH', {minimumFractionDigits: 2})}</td>
                    <td>
                        <div class="row-actions">
                            <button class="duplicate-btn" onclick="duplicateSummaryRow(${row.id})" title="Duplicate">üìã</button>
                            <button class="delete-btn" onclick="deleteSummaryRow(${row.id})" title="Delete">üóëÔ∏è</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            // Add total row
            if (summaryData.length > 0) {
                const totalCost = summaryData.reduce((sum, row) => sum + (row.totalCost || 0), 0);
                const totalMargin = summaryData.reduce((sum, row) => sum + (row.marginCost || 0), 0);
                const grandTotal = summaryData.reduce((sum, row) => sum + (row.totalAmount || 0), 0);
                
                const totalRow = document.createElement('tr');
                totalRow.style.backgroundColor = 'rgba(154, 205, 50, 0.3)';
                totalRow.style.fontWeight = 'bold';
                totalRow.innerHTML = `
                    <td colspan="4" style="text-align: right; padding: 12px; font-weight: 700; color: #2F4F2F;">TOTAL:</td>
                    <td class="calculated" style="font-weight: 700;">‚Ç±${totalCost.toLocaleString('en-PH', {minimumFractionDigits: 2})}</td>
                    <td class="calculated" style="font-weight: 700;">‚Ç±${totalMargin.toLocaleString('en-PH', {minimumFractionDigits: 2})}</td>
                    <td class="calculated" style="font-weight: 700; background: rgba(107, 142, 35, 0.4);">‚Ç±${grandTotal.toLocaleString('en-PH', {minimumFractionDigits: 2})}</td>
                    <td></td>
                `;
                tbody.appendChild(totalRow);
            }
        }

        function updateSummaryTotal() {
            const grandTotal = summaryData.reduce((sum, row) => sum + (row.totalAmount || 0), 0);
            const summaryTotalElement = document.getElementById('summaryGrandTotal');
            if (summaryTotalElement) {
                summaryTotalElement.textContent = `‚Ç±${grandTotal.toLocaleString('en-PH', {minimumFractionDigits: 2})}`;
            }
        }

        function generateSummaryFromBOQ() {
            if (boqData.length === 0) {
                alert('No BOQ data available to generate summary.');
                return;
            }
            
            // Group BOQ data by category
            const categoryTotals = {};
            
            boqData.forEach(row => {
                if (row.category && row.totalAmount > 0) {
                    if (!categoryTotals[row.category]) {
                        categoryTotals[row.category] = 0;
                    }
                    categoryTotals[row.category] += row.totalAmount;
                }
            });
            
            // Clear existing summary data and reset counter properly
            summaryData = [];
            summaryItemCounter = 1;
            
            // Create summary rows from categories with proper item numbering
            let itemNumber = 1;
            Object.entries(categoryTotals).forEach(([category, total]) => {
                const row = {
                    id: Date.now() + Math.random(),
                    itemNo: itemNumber,
                    description: category,
                    quantity: 1,
                    unit: 'lot',
                    totalCost: total,
                    marginCost: 0,
                    totalAmount: 0
                };
                calculateSummaryRow(row);
                summaryData.push(row);
                itemNumber++;
            });
            
            // Update the counter for future additions
            summaryItemCounter = itemNumber;
            
            renderSummaryTable();
            updateSummaryTotal();
            autoSaveCurrentProject();
            
            alert('Summary generated from BOQ data successfully!');
        }

        function exportSummaryToExcel() {
            const projectInfo = {
                'Project ID': document.getElementById('projectId').value,
                'Project Name': document.getElementById('projectName').value,
                'Client Name': document.getElementById('clientName').value,
                'Project Budget': document.getElementById('projectBudget').value,
                'Project Type': document.getElementById('projectType').value
            };
            
            const headers = ['Item No.', 'Description', 'Quantity', 'Unit', 'Total Cost', 'Margin Cost', 'Total Amount'];
            
            const data = summaryData.map(row => [
                row.itemNo, row.description, row.quantity, row.unit,
                row.totalCost, row.marginCost, row.totalAmount
            ]);
            
            const wb = XLSX.utils.book_new();
            
            // Project Info Sheet
            const projectWs = XLSX.utils.json_to_sheet([projectInfo]);
            XLSX.utils.book_append_sheet(wb, projectWs, 'Project Info');
            
            // Summary Sheet
            const summaryWs = XLSX.utils.aoa_to_sheet([headers, ...data]);
            XLSX.utils.book_append_sheet(wb, summaryWs, 'Summary');
            
            const fileName = `Summary_${document.getElementById('projectId').value || 'Project'}_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        // Buffer percentage editing functions
        function editBufferPercentage(type) {
            const currentValue = type === 'discrepancy' ? discrepancyPercentage : 
                               type === 'operation' ? operationPercentage : contingencyPercentage;
            
            const newValue = prompt(`Enter new ${type} percentage:`, currentValue);
            if (newValue !== null && !isNaN(newValue) && newValue >= 0) {
                const percentage = parseFloat(newValue);
                
                if (type === 'discrepancy') {
                    discrepancyPercentage = percentage;
                    document.getElementById('discrepancyPercentage').textContent = percentage;
                } else if (type === 'operation') {
                    operationPercentage = percentage;
                    document.getElementById('operationPercentage').textContent = percentage;
                } else if (type === 'contingency') {
                    contingencyPercentage = percentage;
                    document.getElementById('contingencyPercentage').textContent = percentage;
                }
                
                // Recalculate all rows
                boqData.forEach(row => calculateRow(row));
                renderTable();
                updateSummary();
                updateDashboard();
                autoSaveCurrentProject();
            }
        }

        function editVatPercentage() {
            const newValue = prompt('Enter new VAT percentage:', vatPercentage);
            if (newValue !== null && !isNaN(newValue) && newValue >= 0) {
                vatPercentage = parseFloat(newValue);
                document.getElementById('dashVatPercentage').textContent = vatPercentage;
                updateDashboard();
                autoSaveCurrentProject();
            }
        }

        function updateDiscount() {
            discountAmount = parseFloat(document.getElementById('discountAmount').value) || 0;
            updateDashboard();
            autoSaveCurrentProject();
        }

        function clearDiscount() {
            discountAmount = 0;
            document.getElementById('discountAmount').value = '';
            updateDashboard();
            autoSaveCurrentProject();
        }

        // Auto-save function
        function autoSave() {
            autoSaveCurrentProject();
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97857a9967b4f9a3',t:'MTc1NjczNzE2Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
